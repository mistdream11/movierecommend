doctype html
html
  head
    meta(charset='utf-8')
    meta(name='viewport', content='width=device-width, initial-scale=1')
    title!= title
    // 引入Inter字体（统一风格）
    link(href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap', rel='stylesheet')
    style.
      /* ========== 全局CSS变量（采用loginpage蓝紫调风格） ========== */
      :root {
        /* 主色调 - 蓝紫调（与登录页一致） */
        --primary: #4361ee; /* 核心蓝紫 */
        --primary-light: #5874f5; /* 主色浅调（hover） */
        --primary-dark: #3a56d4; /* 主色深调（active） */
        --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%); /* 蓝紫渐变 */
        
        /* 辅助色 - 与登录页保持一致 */
        --secondary: #ffffff;
        --bg-header: linear-gradient(135deg, #e0f7fa 0%, #f3e5f5 100%); /* 页面渐变背景 */
        --card-bg: #ffffff; /* 纯白卡片 */
        --card-border: rgba(67, 97, 238, 0.15); /* 蓝紫调边框 */
        
        /* 文字色 - 与登录页一致 */
        --text-main: #2d3748;       /* 主要文本（深灰） */
        --text-secondary: #718096;  /* 次要文本（浅灰） */
        --text-tertiary: #5c677d;
        
        /* 功能色 - 适配蓝紫风格 */
        --success: #22c55e;
        --danger: #ef4444;
        --info: #4361ee; /* 使用主色作为信息色 */
        
        /* 尺寸与圆角（与登录页风格匹配） */
        --radius-sm: 6px;
        --radius-md: 10px; /* 与输入框圆角一致 */
        --radius-lg: 16px; /* 与表单圆角一致 */
        --radius-xl: 16px;
        --radius-full: 999px;
        
        /* 阴影 - 蓝紫调柔和阴影（与登录页一致） */
        --shadow-light: rgba(67, 97, 238, 0.08);
        --shadow-medium: rgba(67, 97, 238, 0.12);
        --shadow-strong: rgba(67, 97, 238, 0.18);
        --shadow-btn: 0 4px 12px rgba(67, 97, 238, 0.2); /* 按钮阴影 */
      }

      /* 基础样式重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: all 0.25s ease; /* 稍快的过渡效果 */
        font-smoothing: antialiased;
        -webkit-font-smoothing: antialiased;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', system-ui, -apple-system, sans-serif; /* 与登录页一致的字体栈 */
        background: var(--bg-header); /* 统一的渐变背景 */
        color: var(--text-main);
      }

      .shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 40px 20px 80px;
        max-width: 1400px;
        margin: 0 auto;
      }

      header h1 {
        margin: 0;
        font-size: 34px;
        font-weight: 700;
        /* 标题渐变文字（与登录页一致） */
        background: linear-gradient(135deg, var(--primary), #7b61ee);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 12px;
      }

      header p {
        margin: 6px 0 20px;
        color: var(--text-secondary);
        line-height: 1.6;
        font-size: 15px;
      }

      /* 进度条样式（蓝紫渐变） */
      .progress {
        height: 6px;
        background: rgba(67, 97, 238, 0.1); /* 更浅的背景 */
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-bottom: 25px;
      }

      .progress-bar {
        height: 100%;
        width: 0;
        background: var(--primary-gradient); /* 蓝紫渐变进度条 */
        transition: width 0.3s ease;
      }

      /* 电影网格容器（与登录页表单风格匹配） */
      .movie-grid {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 30px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 30px;
        box-shadow: 
          var(--shadow-light) 0 4px 6px,
          var(--shadow-medium) 0 10px 15px -3px,
          var(--shadow-light) 0 4px 6px -4px;
        border: 1px solid var(--card-border);
        /* 轻微内阴影增加层次感 */
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 
                    var(--shadow-light) 0 4px 6px,
                    var(--shadow-medium) 0 10px 15px -3px,
                    var(--shadow-light) 0 4px 6px -4px;
      }

      .row-title {
        margin: 0 0 12px;
        font-size: 18px;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
        font-weight: 600;
      }

      /* 卡片行布局 */
      .card-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
      }

      /* 电影卡片（与登录页风格匹配） */
      .movie-card {
        position: relative;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        padding-bottom: 12px;
        min-height: 280px;
        transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
      }

      .movie-card:hover {
        transform: translateY(-2px); /* 轻微上浮效果 */
        box-shadow: 
          var(--shadow-light) 0 6px 8px,
          var(--shadow-medium) 0 12px 20px -3px,
          var(--shadow-light) 0 6px 8px -4px;
        border-color: var(--primary-light);
      }

      .movie-card.selected {
        border-color: var(--success);
        box-shadow: 0 12px 30px rgba(34, 197, 94, 0.25);
      }

      .movie-card.ignored {
        opacity: 0.35;
        border-color: rgba(67, 97, 238, 0.1);
      }

      .movie-card img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        display: block;
        border-bottom: 1px solid var(--card-border);
      }

      .movie-card .info {
        padding: 12px 14px 40px;
      }

      .movie-card h3 {
        margin: 0 0 6px;
        font-size: 16px;
        line-height: 1.3;
        font-weight: 600;
        color: var(--text-main);
      }

      .movie-card .tags {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .movie-card .controls {
        position: absolute;
        bottom: 10px;
        right: 12px;
        display: flex;
        gap: 8px;
      }

      /* 按钮样式（与登录页按钮风格统一） */
      .movie-card button {
        border: none;
        border-radius: var(--radius-md);
        padding: 6px 10px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        user-select: none;
      }

      .btn-like {
        background: var(--primary); /* 使用主色 */
        color: white;
        box-shadow: 0 2px 5px rgba(67, 97, 238, 0.2);
      }

      .btn-like:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.25);
      }

      .btn-like:active {
        background: var(--primary-dark);
        transform: translateY(0);
      }

      .movie-card .corner-ignore {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--danger);
        border: none;
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        line-height: 30px;
        text-align: center;
        opacity: 0.8;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
      }

      .movie-card .corner-ignore:hover {
        opacity: 1;
        transform: scale(1.05);
        box-shadow: 0 3px 6px rgba(239, 68, 68, 0.3);
      }

      /* 操作栏样式（与登录页按钮风格统一） */
      .action-bar {
        margin-top: 30px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .action-bar .step-text {
        font-size: 16px;
        color: var(--text-tertiary);
      }

      .action-bar button {
        border: none;
        border-radius: var(--radius-md);
        padding: 14px 36px;
        font-size: 16px;
        cursor: pointer;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        font-weight: 600;
        box-shadow: var(--shadow-btn);
        transition: all 0.25s ease;
        user-select: none;
      }

      .action-bar button:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, var(--primary-light), var(--primary));
        box-shadow: 0 6px 16px rgba(67, 97, 238, 0.25);
      }

      .action-bar button:active {
        transform: translateY(0);
        background: linear-gradient(135deg, var(--primary-dark), #324ebe);
        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.2);
      }

      /* 响应式适配 */
      @media (max-width: 768px) {
        .card-row {
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
        
        .movie-card {
          min-height: 240px;
        }
        
        .movie-card img {
          height: 140px;
        }
        
        .action-bar {
          justify-content: center;
        }
        
        .action-bar .step-text {
          width: 100%;
          text-align: center;
          margin-bottom: 12px;
        }
        
        header h1 {
          font-size: 28px;
        }
      }

  body
    .shell
      header
        h1 #{modeLabel}
        p 请选择你感兴趣的电影：上排为符合你标签的影片，下排为其他影片。点击"喜欢"表示 5 分，保持默认即 1 分；点击右上角红色 × 表示没看过，将不会计分。
      .progress
        .progress-bar(id='progressBar')
      .movie-grid
        section
          p.row-title 标签匹配电影
          .card-row(id='topRow')
        section
          p.row-title 其他电影
          .card-row(id='bottomRow')
      .action-bar
        span.step-text(id='stepInfo')
        button(type='button', id='nextBtn') 下一步
    form#ratingForm(action='/submituserscore', method='post')
      input(type='hidden', name='userid', value=userid)
      input(type='hidden', name='username', value=username)
    script.
      // 安全的HTML转义函数
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // 安全的属性转义函数
      function escapeAttr(text) {
        return String(text)
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }
      
      const ratingConfig = {
        userid: !{JSON.stringify(userid)},
        username: !{JSON.stringify(username)},
        stepsNeeded: !{JSON.stringify(stepsNeeded)},
        modeLabel: !{JSON.stringify(modeLabel)},
        selectedGenres: !{JSON.stringify(selectedGenres)},
        matchingMovies: !{JSON.stringify(matchingMovies)},
        fillerMovies: !{JSON.stringify(fillerMovies)}
      };
      
      (function() {
        const perCategory = 5;
        const progressBar = document.getElementById('progressBar');
        const topRow = document.getElementById('topRow');
        const bottomRow = document.getElementById('bottomRow');
        const stepInfo = document.getElementById('stepInfo');
        const nextBtn = document.getElementById('nextBtn');
        const state = {
          currentStep: 0,
          cardStates: {}
        };

        function sliceMovies(list, stepIndex) {
          const start = stepIndex * perCategory;
          return list.slice(start, start + perCategory);
        }

        function ensureState(movie) {
          if (!state.cardStates[movie.movieid]) {
            state.cardStates[movie.movieid] = {
              info: movie,
              rating: 1,
              ignored: false
            };
          }
        }

        function getPoster(movie) {
          // 蓝紫风格占位图（与登录页一致）
          return movie.picture && movie.picture.length ? movie.picture : 'https://dummyimage.com/300x420/e0f7fa/4361ee&text=Movie';
        }

        function createCard(movie, rowEl) {
          ensureState(movie);
          const card = document.createElement('div');
          card.className = 'movie-card';
          card.dataset.movieId = movie.movieid;
          
          // 使用转义后的值
          const posterUrl = escapeAttr(getPoster(movie));
          const movieName = escapeHtml(movie.moviename || '未命名影片');
          const movieAlt = escapeAttr(movie.moviename || '');
          const movieGenre = escapeHtml(movie.genre || '暂无标签');
          
          card.innerHTML = [
            '<button type="button" class="corner-ignore">×</button>',
            '<img src="' + posterUrl + '" alt="' + movieAlt + '" />',
            '<div class="info">',
            '  <h3>' + movieName + '</h3>',
            '  <p class="tags">' + movieGenre + '</p>',
            '</div>',
            '<div class="controls">',
            '  <button type="button" class="btn-like">喜欢</button>',
            '</div>'
          ].join('');
          
          rowEl.appendChild(card);
          bindCardEvents(card, movie.movieid);
          refreshCardState(card, movie.movieid);
        }

        function bindCardEvents(card, movieId) {
          const likeBtn = card.querySelector('.btn-like');
          const ignoreBtn = card.querySelector('.corner-ignore');
          likeBtn.addEventListener('click', function() {
            const record = state.cardStates[movieId];
            record.ignored = false;
            record.rating = record.rating === 5 ? 1 : 5;
            refreshCardState(card, movieId);
          });
          ignoreBtn.addEventListener('click', function() {
            const record = state.cardStates[movieId];
            record.ignored = !record.ignored;
            if (record.ignored) {
              record.rating = null;
            } else {
              record.rating = 1;
            }
            refreshCardState(card, movieId);
          });
        }

        function refreshCardState(card, movieId) {
          const record = state.cardStates[movieId];
          card.classList.remove('selected', 'ignored');
          if (record.ignored) {
            card.classList.add('ignored');
          } else if (record.rating === 5) {
            card.classList.add('selected');
          }
        }

        function renderStep() {
          const step = state.currentStep;
          const topMovies = sliceMovies(ratingConfig.matchingMovies, step);
          const bottomMovies = sliceMovies(ratingConfig.fillerMovies, step);

          topRow.innerHTML = '';
          bottomRow.innerHTML = '';

          topMovies.forEach((movie) => createCard(movie, topRow));
          bottomMovies.forEach((movie) => createCard(movie, bottomRow));

          const progress = ((step) / ratingConfig.stepsNeeded) * 100;
          progressBar.style.width = progress + '%';
          const finalStep = ratingConfig.stepsNeeded - 1;
          stepInfo.textContent = '第 ' + (step + 1) + ' / ' + ratingConfig.stepsNeeded + ' 轮';
          nextBtn.textContent = step === finalStep ? '提交' : '下一步';
        }

        function submitRatings() {
          const movieIds = [];
          const movieScores = [];
          Object.keys(state.cardStates).forEach((movieId) => {
            const entry = state.cardStates[movieId];
            if (entry.ignored) {
              return;
            }
            if (entry.rating === null) {
              return;
            }
            movieIds.push(movieId);
            movieScores.push(entry.rating === 5 ? 5 : 1);
          });

          if (!movieIds.length) {
            alert('请至少选择一个电影或取消全部未看状态。');
            return;
          }

          const form = document.getElementById('ratingForm');
          form.innerHTML = '';
          const hiddenUser = document.createElement('input');
          hiddenUser.type = 'hidden';
          hiddenUser.name = 'userid';
          hiddenUser.value = ratingConfig.userid;
          form.appendChild(hiddenUser);
          const hiddenUsername = document.createElement('input');
          hiddenUsername.type = 'hidden';
          hiddenUsername.name = 'username';
          hiddenUsername.value = ratingConfig.username;
          form.appendChild(hiddenUsername);

          movieIds.forEach((id, index) => {
            const mid = document.createElement('input');
            mid.type = 'hidden';
            mid.name = 'movieid';
            mid.value = id;
            form.appendChild(mid);
            const score = document.createElement('input');
            score.type = 'hidden';
            score.name = 'moviescore';
            score.value = movieScores[index];
            form.appendChild(score);
          });

          form.submit();
        }

        nextBtn.addEventListener('click', function() {
          if (state.currentStep < ratingConfig.stepsNeeded - 1) {
            state.currentStep += 1;
            renderStep();
          } else {
            submitRatings();
          }
        });

        renderStep();
      })();